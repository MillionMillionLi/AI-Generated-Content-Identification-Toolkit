<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多模态水印工具 - 业务流程时序图</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10.6.1/dist/mermaid.min.js"></script>
    <style>
        body {
            font-family: 'Microsoft YaHei', Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1600px;
            margin: 0 auto;
            background-color: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
            font-size: 28px;
        }
        .tab-container {
            margin: 30px 0;
        }
        .tabs {
            display: flex;
            background-color: #f8f9fa;
            border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        .tab {
            flex: 1;
            padding: 15px 20px;
            background-color: #e9ecef;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: background-color 0.3s;
            color: #495057;
        }
        .tab:hover {
            background-color: #dee2e6;
        }
        .tab.active {
            background-color: #007bff;
            color: white;
        }
        .tab-content {
            display: none;
            background-color: white;
            border: 1px solid #dee2e6;
            border-top: none;
            border-radius: 0 0 8px 8px;
            padding: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .description {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 30px 0;
            border-left: 4px solid #007bff;
        }
        .flow-steps {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 30px 0;
        }
        .step-card {
            background-color: #ffffff;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #dee2e6;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .step-card h3 {
            color: #495057;
            margin-top: 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .step-number {
            background-color: #007bff;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }
        .step-card ul {
            list-style-type: none;
            padding: 0;
        }
        .step-card li {
            padding: 5px 0;
            border-bottom: 1px solid #f1f3f4;
        }
        .step-card li:before {
            content: "▶ ";
            color: #007bff;
            font-weight: bold;
        }
        #mermaid-embed, #mermaid-extract {
            text-align: center;
            margin: 30px 0;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            overflow-x: auto;
        }
        .performance-comparison {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background-color: white;
        }
        .performance-comparison th,
        .performance-comparison td {
            border: 1px solid #dee2e6;
            padding: 12px;
            text-align: center;
        }
        .performance-comparison th {
            background-color: #007bff;
            color: white;
            font-weight: bold;
        }
        .performance-comparison tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        .highlight {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .warning {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>⏱️ 多模态水印工具 - 业务流程时序图</h1>
        
        <div class="description">
            <h2>📋 流程概览</h2>
            <p>本系统提供<strong>水印嵌入</strong>和<strong>水印提取</strong>两大核心业务流程。支持文本、图像、音频、视频四种模态，通过统一的API接口实现智能路由和模型管理，确保高效可靠的水印处理。</p>
        </div>

        <div class="tab-container">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('embed')">🔐 水印嵌入流程</button>
                <button class="tab" onclick="switchTab('extract')">🔍 水印提取流程</button>
            </div>
            
            <div id="embed-content" class="tab-content active">
                <h2>🔐 水印嵌入流程 (Watermark Embedding)</h2>
                <div id="mermaid-embed">
                    <div class="mermaid">
sequenceDiagram
    participant User as 👤 用户
    participant Web as 🌐 Web界面
    participant Tool as 🛠️ WatermarkTool
    participant Engine as ⚙️ UnifiedEngine
    participant TextWM as 📝 文本水印
    participant ImageWM as 🖼️ 图像水印
    participant AudioWM as 🎵 音频水印
    participant VideoWM as 🎬 视频水印
    participant ModelMgr as 🏗️ 模型管理器
    participant Cache as 💾 模型缓存

    Note over User,Cache: 📋 水印嵌入业务流程
    
    User->>+Web: 1. 选择模态，输入提示词和水印消息
    Web->>+Tool: 2. embed(prompt, message, modality, **kwargs)
    Tool->>+Engine: 3. 路由到对应模态处理器
    
    alt 📝 文本水印嵌入
        Engine->>+TextWM: embed(model, tokenizer, prompt, message)
        TextWM->>+ModelMgr: 请求LLM模型和分词器
        ModelMgr->>+Cache: 加载缓存的文本模型
        Cache-->>-ModelMgr: 返回模型/分词器
        ModelMgr-->>-TextWM: 模型初始化完成
        TextWM->>TextWM: CredID算法处理 (logits修改)
        Note right of TextWM: • 多段消息编码<br/>• 智能分割处理<br/>• LM/Random模式
        TextWM-->>-Engine: 返回带水印文本
        
    else 🖼️ 图像水印嵌入
        Engine->>+ImageWM: embed(prompt, message, algorithm)
        ImageWM->>+ModelMgr: 请求Stable Diffusion模型
        ModelMgr->>+Cache: 加载图像生成模型
        Cache-->>-ModelMgr: 返回扩散模型
        ModelMgr-->>-ImageWM: 模型初始化完成
        ImageWM->>ImageWM: 生成图像并嵌入水印
        Note right of ImageWM: • PRC/VideoSeal算法<br/>• 潜空间水印嵌入<br/>• 支持多种分辨率
        ImageWM-->>-Engine: 返回带水印图像(PIL.Image)
        
    else 🎵 音频水印嵌入
        Engine->>+AudioWM: embed(audio, message, **params)
        AudioWM->>+ModelMgr: 请求AudioSeal模型
        ModelMgr->>+Cache: 加载音频处理模型
        Cache-->>-ModelMgr: 返回AudioSeal模型
        ModelMgr-->>-AudioWM: 模型初始化完成
        AudioWM->>AudioWM: AudioSeal深度学习水印
        Note right of AudioWM: • 16位消息编码<br/>• SNR > 44dB高保真<br/>• 可选Bark TTS
        AudioWM-->>-Engine: 返回带水印音频
        
    else 🎬 视频水印嵌入
        Engine->>+VideoWM: embed(prompt, message, **video_params)
        VideoWM->>+ModelMgr: 请求HunyuanVideo模型
        ModelMgr->>+Cache: 加载视频生成模型
        Cache-->>-ModelMgr: 返回文生视频模型
        ModelMgr-->>-VideoWM: 模型初始化完成
        VideoWM->>VideoWM: 生成视频 + VideoSeal水印
        Note right of VideoWM: • HunyuanVideo文生视频<br/>• VideoSeal帧级水印<br/>• 支持多帧处理
        VideoWM-->>-Engine: 返回带水印视频路径
    end
    
    Engine-->>-Tool: 返回处理结果
    Tool-->>-Web: 返回嵌入成功结果
    Web-->>-User: 显示结果，提供下载链接

    Note over User,Cache: ✅ 嵌入完成，水印已隐式嵌入到内容中
                    </div>
                </div>
                
                <div class="flow-steps">
                    <div class="step-card">
                        <h3><span class="step-number">1</span>用户输入</h3>
                        <ul>
                            <li>选择水印模态 (文本/图像/音频/视频)</li>
                            <li>输入内容生成提示词</li>
                            <li>指定要嵌入的水印消息</li>
                            <li>配置算法参数 (可选)</li>
                        </ul>
                    </div>
                    
                    <div class="step-card">
                        <h3><span class="step-number">2</span>引擎路由</h3>
                        <ul>
                            <li>WatermarkTool接收用户请求</li>
                            <li>UnifiedEngine智能路由</li>
                            <li>根据模态选择对应处理器</li>
                            <li>传递参数到具体算法</li>
                        </ul>
                    </div>
                    
                    <div class="step-card">
                        <h3><span class="step-number">3</span>模型加载</h3>
                        <ul>
                            <li>模型管理器懒加载机制</li>
                            <li>优先使用本地缓存模型</li>
                            <li>自动设备适配 (CPU/GPU)</li>
                            <li>模型初始化和预热</li>
                        </ul>
                    </div>
                    
                    <div class="step-card">
                        <h3><span class="step-number">4</span>水印嵌入</h3>
                        <ul>
                            <li>根据算法执行水印嵌入</li>
                            <li>保持内容质量不降低</li>
                            <li>水印信息隐式编码</li>
                            <li>返回带水印的结果</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <div id="extract-content" class="tab-content">
                <h2>🔍 水印提取流程 (Watermark Extraction)</h2>
                <div id="mermaid-extract">
                    <div class="mermaid">
sequenceDiagram
    participant User as 👤 用户
    participant Web as 🌐 Web界面
    participant Tool as 🛠️ WatermarkTool
    participant Engine as ⚙️ UnifiedEngine
    participant TextWM as 📝 文本水印
    participant ImageWM as 🖼️ 图像水印
    participant AudioWM as 🎵 音频水印
    participant VideoWM as 🎬 视频水印
    participant ModelMgr as 🏗️ 模型管理器
    participant Cache as 💾 模型缓存

    Note over User,Cache: 🔍 水印提取业务流程
    
    User->>+Web: 1. 上传待检测文件
    Web->>+Tool: 2. extract(content, modality, **kwargs)
    Tool->>+Engine: 3. 路由到对应模态检测器
    
    alt 📝 文本水印提取
        Engine->>+TextWM: extract(text, model, tokenizer, candidates)
        TextWM->>+ModelMgr: 请求相同的LLM模型
        ModelMgr->>+Cache: 获取模型 (已缓存)
        Cache-->>-ModelMgr: 返回缓存模型
        ModelMgr-->>-TextWM: 模型就绪
        TextWM->>TextWM: CredID解码算法检测
        Note right of TextWM: • 候选消息优化搜索<br/>• 智能匹配算法<br/>• 置信度计算
        TextWM-->>-Engine: {detected: true, message: "xxx", confidence: 0.95}
        
    else 🖼️ 图像水印提取
        Engine->>+ImageWM: extract(image, mode, replicate, chunk_size)
        ImageWM->>+ModelMgr: 请求相同的扩散模型
        ModelMgr->>+Cache: 获取模型 (已缓存)
        Cache-->>-ModelMgr: 返回扩散模型
        ModelMgr-->>-ImageWM: 模型就绪
        ImageWM->>ImageWM: 图像逆向 + 水印检测
        Note right of ImageWM: • exact_inversion逆向<br/>• 多精度模式支持<br/>• 单图多帧增强
        ImageWM-->>-Engine: {detected: true, message: "xxx", confidence: 1.0}
        
    else 🎵 音频水印提取
        Engine->>+AudioWM: extract(audio, detection_threshold)
        AudioWM->>+ModelMgr: 请求AudioSeal检测器
        ModelMgr->>+Cache: 获取检测模型 (已缓存)
        Cache-->>-ModelMgr: 返回检测器模型
        ModelMgr-->>-AudioWM: 模型就绪
        AudioWM->>AudioWM: AudioSeal深度学习检测
        Note right of AudioWM: • 3D张量处理<br/>• 消息匹配算法<br/>• 设备一致性管理
        AudioWM-->>-Engine: {detected: true, message: "xxx", confidence: 0.98}
        
    else 🎬 视频水印提取
        Engine->>+VideoWM: extract(video_path, max_frames, chunk_size)
        VideoWM->>+ModelMgr: 请求VideoSeal检测器
        ModelMgr->>+Cache: 获取视频模型 (已缓存)
        Cache-->>-ModelMgr: 返回检测模型
        ModelMgr-->>-VideoWM: 模型就绪
        VideoWM->>VideoWM: 多帧批量检测 + 聚合
        Note right of VideoWM: • 帧级水印检测<br/>• 分块处理优化<br/>• 置信度聚合
        VideoWM-->>-Engine: {detected: true, message: "xxx", confidence: 0.92}
    end
    
    Engine-->>-Tool: 返回统一格式检测结果
    Tool-->>-Web: 返回检测结果和元数据
    Web-->>-User: 显示检测结果、置信度和详细信息

    Note over User,Cache: ✅ 检测完成，显示水印信息和可信度评估
                    </div>
                </div>
                
                <div class="flow-steps">
                    <div class="step-card">
                        <h3><span class="step-number">1</span>文件上传</h3>
                        <ul>
                            <li>支持多种文件格式</li>
                            <li>自动识别内容模态</li>
                            <li>文件大小和格式验证</li>
                            <li>安全性检查和预处理</li>
                        </ul>
                    </div>
                    
                    <div class="step-card">
                        <h3><span class="step-number">2</span>检测路由</h3>
                        <ul>
                            <li>根据模态选择检测器</li>
                            <li>参数配置和优化</li>
                            <li>模型复用 (已加载缓存)</li>
                            <li>检测算法初始化</li>
                        </ul>
                    </div>
                    
                    <div class="step-card">
                        <h3><span class="step-number">3</span>水印检测</h3>
                        <ul>
                            <li>算法特异性检测处理</li>
                            <li>多种优化技术应用</li>
                            <li>置信度计算和验证</li>
                            <li>错误处理和降级策略</li>
                        </ul>
                    </div>
                    
                    <div class="step-card">
                        <h3><span class="step-number">4</span>结果返回</h3>
                        <ul>
                            <li>统一格式的检测结果</li>
                            <li>详细的元数据信息</li>
                            <li>置信度和质量评估</li>
                            <li>用户友好的结果展示</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div class="description">
            <h2>⚡ 性能对比分析</h2>
            <table class="performance-comparison">
                <thead>
                    <tr>
                        <th>模态</th>
                        <th>嵌入时间</th>
                        <th>提取时间</th>
                        <th>检测成功率</th>
                        <th>质量保持</th>
                        <th>批处理能力</th>
                        <th>特色优势</th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td>📝 文本</td>
                        <td>快速</td>
                        <td>快速</td>
                        <td class="highlight">高</td>
                        <td>原生质量</td>
                        <td>支持</td>
                        <td>多方水印，候选优化</td>
                    </tr>
                    <tr>
                        <td>🖼️ 图像</td>
                        <td>0.19s-52s</td>
                        <td>同嵌入</td>
                        <td class="highlight">100%</td>
                        <td>高质量生成</td>
                        <td>支持</td>
                        <td>三种精度模式可选</td>
                    </tr>
                    <tr>
                        <td>🎵 音频</td>
                        <td class="highlight">0.93s</td>
                        <td class="highlight">0.04s</td>
                        <td class="highlight">100%</td>
                        <td>SNR > 44dB</td>
                        <td class="highlight">高效</td>
                        <td>实时处理，TTS集成</td>
                    </tr>
                    <tr>
                        <td>🎬 视频</td>
                        <td>约3秒</td>
                        <td>分帧处理</td>
                        <td>高</td>
                        <td>320x512</td>
                        <td>支持</td>
                        <td>文生视频+水印一体化</td>
                    </tr>
                </tbody>
            </table>
        </div>

        <div class="description">
            <h2>🎯 核心技术特点</h2>
            <div class="flow-steps">
                <div class="step-card">
                    <h3>🚀 统一API设计</h3>
                    <ul>
                        <li>所有模态使用相同的embed/extract接口</li>
                        <li>参数标准化，易于集成和使用</li>
                        <li>统一的返回格式和错误处理</li>
                    </ul>
                </div>
                
                <div class="step-card">
                    <h3>🧠 智能模型管理</h3>
                    <ul>
                        <li>懒加载机制，按需初始化模型</li>
                        <li>离线优先，支持本地缓存模型</li>
                        <li>自动设备适配和内存优化</li>
                    </ul>
                </div>
                
                <div class="step-card">
                    <h3>⚡ 高性能处理</h3>
                    <ul>
                        <li>并行处理和批处理支持</li>
                        <li>多精度模式，速度质量可选</li>
                        <li>实时检测能力，生产环境就绪</li>
                    </ul>
                </div>
                
                <div class="step-card">
                    <h3>🛡️ 可靠性保障</h3>
                    <ul>
                        <li>完善的错误处理和降级策略</li>
                        <li>详细的日志记录和监控</li>
                        <li>多种验证机制确保结果可信</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <script>
        function switchTab(tabName) {
            // 隐藏所有内容
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // 移除所有tab的active状态
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // 显示选中的内容
            document.getElementById(tabName + '-content').classList.add('active');
            
            // 设置选中tab的active状态
            event.target.classList.add('active');
            
            // 重新初始化Mermaid图表
            mermaid.init(undefined, document.querySelectorAll('.mermaid'));
        }

        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            sequence: {
                diagramMarginX: 50,
                diagramMarginY: 10,
                actorMargin: 50,
                width: 150,
                height: 65,
                boxMargin: 10,
                boxTextMargin: 5,
                noteMargin: 10,
                messageMargin: 35,
                mirrorActors: true,
                bottomMarginAdj: 1,
                useMaxWidth: true,
                rightAngles: false,
                showSequenceNumbers: false,
                actorFontSize: 14,
                actorFontFamily: 'Microsoft YaHei, Arial, sans-serif',
                noteFontSize: 12,
                noteFontFamily: 'Microsoft YaHei, Arial, sans-serif',
                messageFontSize: 12,
                messageFontFamily: 'Microsoft YaHei, Arial, sans-serif'
            }
        });
    </script>
</body>
</html>