# ç®€åŒ–ç‰ˆå¤šæ¨¡æ€æ°´å°å·¥å…· - å¿«é€Ÿä¸Šæ‰‹æŒ‡å—

## ğŸ¯ ç›®æ ‡æ˜ç¡®

æˆ‘ä»¬è¦åšçš„æ˜¯ä¸€ä¸ª**æœ€å°å¯ç”¨**çš„å¤šæ¨¡æ€æ°´å°å·¥å…·ï¼š
- âœ… **æ–‡æœ¬æ°´å°**ï¼šåªç”¨CredIDç®—æ³•  
- âœ… **å›¾åƒæ°´å°**ï¼šåªç”¨Stable Signatureç®—æ³•
- âœ… **ç»Ÿä¸€æ¥å£**ï¼šä¸€ä¸ªEngineç±»æå®šæ‰€æœ‰æ“ä½œ
- âŒ ä¸è¦å¤æ‚çš„è¯„ä¼°æ¨¡å—
- âŒ ä¸è¦å¤šç®—æ³•æ”¯æŒ
- âŒ ä¸è¦å¤æ‚çš„æŠ½è±¡å±‚

## ğŸš€ ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºé¡¹ç›®

### 1. åŸºç¡€ç›®å½•ç»“æ„

```bash
mkdir mmwt && cd mmwt

# åˆ›å»ºæ ¸å¿ƒç›®å½•
mkdir -p src/{text_watermark,image_watermark,utils}
mkdir -p config examples tests models

# åˆ›å»ºå¿…è¦æ–‡ä»¶
touch README.md requirements.txt setup.py
touch src/__init__.py
touch src/text_watermark/__init__.py
touch src/image_watermark/__init__.py
touch src/utils/__init__.py
```

### 2. å®‰è£…ä¾èµ–

```bash
# requirements.txt
cat > requirements.txt << EOF
torch>=1.12.0
transformers>=4.19.2
numpy>=1.20.0
torchvision
Pillow
omegaconf>=2.1.1
pyyaml
tqdm
click
EOF

pip install -r requirements.txt
```

## ğŸ“ ç¬¬äºŒæ­¥ï¼šæ ¸å¿ƒå¼•æ“å®ç°

### åˆ›å»ºç»Ÿä¸€å¼•æ“ (`src/watermark_engine.py`)

```python
import yaml
import os

class WatermarkEngine:
    """ç®€å•çš„å¤šæ¨¡æ€æ°´å°å¼•æ“"""
    
    def __init__(self, base_dir="."):
        self.base_dir = base_dir
        self.text_watermark = None
        self.image_watermark = None
    
    def _load_text_watermark(self):
        """æ‡’åŠ è½½æ–‡æœ¬æ°´å°"""
        if self.text_watermark is None:
            from .text_watermark.credid_watermark import CredIDWatermark
            config_path = os.path.join(self.base_dir, "config/text_config.yaml")
            self.text_watermark = CredIDWatermark(config_path)
        return self.text_watermark
    
    def _load_image_watermark(self):
        """æ‡’åŠ è½½å›¾åƒæ°´å°"""
        if self.image_watermark is None:
            from .image_watermark.stable_signature import StableSignatureWatermark
            config_path = os.path.join(self.base_dir, "config/image_config.yaml")
            self.image_watermark = StableSignatureWatermark(config_path)
        return self.image_watermark
    
    # æ–‡æœ¬æ°´å°æ¥å£
    def embed_text(self, model, tokenizer, prompt, message):
        return self._load_text_watermark().embed(model, tokenizer, prompt, message)
    
    def extract_text(self, watermarked_text):
        return self._load_text_watermark().extract(watermarked_text)
    
    # å›¾åƒæ°´å°æ¥å£  
    def embed_image(self, model, prompt, message):
        return self._load_image_watermark().embed(model, prompt, message)
    
    def extract_image(self, watermarked_image):
        return self._load_image_watermark().extract(watermarked_image)
```

## ğŸ”§ ç¬¬ä¸‰æ­¥ï¼šå¤åˆ¶åŸå§‹ä»£ç 

### 1. ä»CredIDé¡¹ç›®å¤åˆ¶ä»£ç 

```bash
# åœ¨mmwtç›®å½•ä¸‹
cp -r /path/to/credible_LLM_watermarking/watermarking/CredID src/text_watermark/credid

# å¤åˆ¶å¿…è¦çš„å·¥å…·å‡½æ•°
cp /path/to/credible_LLM_watermarking/src/utils/*.py src/utils/
```

### 2. ä»Stable Signatureé¡¹ç›®å¤åˆ¶ä»£ç 

```bash
# å¤åˆ¶æ ¸å¿ƒå®ç°æ–‡ä»¶
cp -r /path/to/stable_signature/src src/image_watermark/stable_sig
cp /path/to/stable_signature/utils*.py src/image_watermark/
```

## ğŸ“„ ç¬¬å››æ­¥ï¼šåˆ›å»ºé…ç½®æ–‡ä»¶

### æ–‡æœ¬é…ç½® (`config/text_config.yaml`)

```yaml
method: "CredID"
model_name: "huggyllama/llama-7b"  # å¯æ ¹æ®éœ€è¦ä¿®æ”¹
max_new_tokens: 110
num_beams: 4

# CredIDç®—æ³•å‚æ•°ï¼ˆæ¥è‡ªåŸå§‹CredID.jsonï¼‰
lm_params:
  delta: 1.5
  prefix_len: 10
  message_len: 10
  permutation_num: 50

wm_params:
  encode_ratio: 10
  max_confidence: 0.5
  strategy: "max_confidence_updated"
```

### å›¾åƒé…ç½® (`config/image_config.yaml`)

```yaml
method: "stable_signature"
message_length: 48
decoder_path: "models/dec_48b_whit.torchscript.pt"

# æ‰©æ•£æ¨¡å‹è®¾ç½®
diffusion:
  model_name: "stabilityai/stable-diffusion-2"
  num_inference_steps: 50
  guidance_scale: 7.5
```

## ğŸ¨ ç¬¬äº”æ­¥ï¼šåˆ›å»ºå°è£…ç±»

### æ–‡æœ¬æ°´å°å°è£… (`src/text_watermark/credid_watermark.py`)

```python
import yaml
import sys
import os

# æ·»åŠ CredIDæ¨¡å—åˆ°è·¯å¾„
credid_path = os.path.join(os.path.dirname(__file__), 'credid')
sys.path.append(credid_path)

class CredIDWatermark:
    """CredIDç®—æ³•çš„ç®€å•å°è£…"""
    
    def __init__(self, config_path):
        with open(config_path, 'r') as f:
            self.config = yaml.safe_load(f)
        
        # è¿™é‡Œéœ€è¦æ ¹æ®å®é™…çš„CredIDå®ç°æ¥è°ƒæ•´
        # å…ˆåˆ›å»ºä¸€ä¸ªå ä½ç¬¦å®ç°
        self._setup_credid()
    
    def _setup_credid(self):
        """åˆå§‹åŒ–CredIDç»„ä»¶"""
        # TODO: æ ¹æ®å®é™…çš„CredIDå®ç°æ¥åˆå§‹åŒ–
        # å¯èƒ½éœ€è¦å¯¼å…¥ message_model_processor ç­‰
        pass
    
    def embed(self, model, tokenizer, prompt, message):
        """åµŒå…¥æ–‡æœ¬æ°´å°"""
        # TODO: è°ƒç”¨å®é™…çš„CredIDåµŒå…¥é€»è¾‘
        # è¿™é‡Œå…ˆè¿”å›ç¤ºä¾‹ç»“æœ
        watermarked_text = f"{prompt} [WATERMARKED with {message}]"
        
        return {
            'watermarked_text': watermarked_text,
            'message': message,
            'success': True
        }
    
    def extract(self, watermarked_text):
        """æå–æ–‡æœ¬æ°´å°"""
        # TODO: è°ƒç”¨å®é™…çš„CredIDæå–é€»è¾‘
        # è¿™é‡Œå…ˆè¿”å›ç¤ºä¾‹ç»“æœ
        if '[WATERMARKED with' in watermarked_text:
            # ç®€å•çš„ç¤ºä¾‹æå–
            return {
                'extracted_message': "demo_message",
                'confidence': 0.95,
                'success': True
            }
        
        return {
            'extracted_message': None,
            'confidence': 0.0,
            'success': False
        }
```

### å›¾åƒæ°´å°å°è£… (`src/image_watermark/stable_signature.py`)

```python
import yaml
import sys
import os
from PIL import Image

class StableSignatureWatermark:
    """Stable Signatureç®—æ³•çš„ç®€å•å°è£…"""
    
    def __init__(self, config_path):
        with open(config_path, 'r') as f:
            self.config = yaml.safe_load(f)
        
        self._setup_stable_signature()
    
    def _setup_stable_signature(self):
        """åˆå§‹åŒ–Stable Signatureç»„ä»¶"""
        # TODO: æ ¹æ®å®é™…çš„Stable Signatureå®ç°æ¥åˆå§‹åŒ–
        pass
    
    def embed(self, model, prompt, message):
        """åµŒå…¥å›¾åƒæ°´å°"""
        # TODO: è°ƒç”¨å®é™…çš„Stable SignatureåµŒå…¥é€»è¾‘
        # è¿™é‡Œå…ˆè¿”å›ç¤ºä¾‹ç»“æœ
        dummy_image = Image.new('RGB', (512, 512), color='red')
        
        return {
            'watermarked_image': dummy_image,
            'message': message,
            'success': True
        }
    
    def extract(self, watermarked_image):
        """æå–å›¾åƒæ°´å°"""
        # TODO: è°ƒç”¨å®é™…çš„Stable Signatureæå–é€»è¾‘
        # è¿™é‡Œå…ˆè¿”å›ç¤ºä¾‹ç»“æœ
        return {
            'extracted_message': "demo_image_message",
            'confidence': 0.88,
            'success': True
        }
```

## ğŸ§ª ç¬¬å…­æ­¥ï¼šæµ‹è¯•è¿è¡Œ

### åˆ›å»ºç®€å•æµ‹è¯• (`examples/quick_test.py`)

```python
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'src'))

from watermark_engine import WatermarkEngine

def test_basic_functionality():
    """æµ‹è¯•åŸºç¡€åŠŸèƒ½"""
    print("ğŸ§ª å¼€å§‹æµ‹è¯•å¤šæ¨¡æ€æ°´å°å·¥å…·...")
    
    # åˆå§‹åŒ–å¼•æ“
    engine = WatermarkEngine(base_dir="..")
    
    # æµ‹è¯•æ–‡æœ¬æ°´å°ï¼ˆå…ˆç”¨ç®€å•ç¤ºä¾‹ï¼‰
    print("\nğŸ“ æµ‹è¯•æ–‡æœ¬æ°´å°...")
    try:
        text_result = engine.embed_text(None, None, "Hello world", "secret123")
        print(f"âœ… åµŒå…¥æˆåŠŸ: {text_result}")
        
        extracted = engine.extract_text(text_result['watermarked_text'])
        print(f"âœ… æå–æˆåŠŸ: {extracted}")
    except Exception as e:
        print(f"âŒ æ–‡æœ¬æ°´å°æµ‹è¯•å¤±è´¥: {e}")
    
    # æµ‹è¯•å›¾åƒæ°´å°
    print("\nğŸ–¼ï¸ æµ‹è¯•å›¾åƒæ°´å°...")
    try:
        image_result = engine.embed_image(None, "a cat", "secret456")
        print(f"âœ… åµŒå…¥æˆåŠŸ: å›¾åƒå¤§å° {image_result['watermarked_image'].size}")
        
        extracted = engine.extract_image(image_result['watermarked_image'])
        print(f"âœ… æå–æˆåŠŸ: {extracted}")
    except Exception as e:
        print(f"âŒ å›¾åƒæ°´å°æµ‹è¯•å¤±è´¥: {e}")
    
    print("\nğŸ‰ åŸºç¡€æµ‹è¯•å®Œæˆï¼")

if __name__ == "__main__":
    test_basic_functionality()
```

### è¿è¡Œæµ‹è¯•

```bash
cd examples
python quick_test.py
```

## ğŸ“š ç¬¬ä¸ƒæ­¥ï¼šå®Œå–„å®ç°

å½“åŸºç¡€æ¡†æ¶å¯ä»¥è¿è¡Œåï¼Œé€æ­¥å®Œå–„ï¼š

### 1. ç ”ç©¶CredIDå®ç°
```bash
# æŸ¥çœ‹CredIDçš„å…³é”®æ–‡ä»¶
ls credible_LLM_watermarking/watermarking/CredID/
# é‡ç‚¹å…³æ³¨ï¼š
# - message_model_processor.py
# - base_processor.py
```

### 2. ç ”ç©¶Stable Signatureå®ç°
```bash
# æŸ¥çœ‹Stable Signatureçš„å…³é”®æ–‡ä»¶
ls stable_signature/
# é‡ç‚¹å…³æ³¨ï¼š
# - finetune_ldm_decoder.py
# - decoding.ipynb
# - utils_model.py
```

### 3. é€æ­¥æ›¿æ¢å ä½ç¬¦ä»£ç 
- åœ¨`credid_watermark.py`ä¸­å®ç°çœŸå®çš„CredIDè°ƒç”¨
- åœ¨`stable_signature.py`ä¸­å®ç°çœŸå®çš„Stable Signatureè°ƒç”¨

## ğŸ¯ æˆåŠŸæ ‡å‡†

å½“ä½ å®Œæˆè¿™ä¸ªç®€åŒ–ç‰ˆæœ¬æ—¶ï¼Œåº”è¯¥èƒ½å¤Ÿï¼š

1. âœ… **åŸºç¡€åŠŸèƒ½**ï¼šé€šè¿‡ç»Ÿä¸€æ¥å£è¿›è¡Œæ–‡æœ¬å’Œå›¾åƒæ°´å°çš„åµŒå…¥/æå–
2. âœ… **é…ç½®é©±åŠ¨**ï¼šé€šè¿‡YAMLæ–‡ä»¶é…ç½®ç®—æ³•å‚æ•°
3. âœ… **ä»£ç æ¸…æ™°**ï¼šç»“æ„ç®€å•ï¼Œæ˜“äºç†è§£å’Œä¿®æ”¹
4. âœ… **å¯æ‰©å±•**ï¼šä¸ºæœªæ¥æ·»åŠ éŸ³é¢‘/è§†é¢‘æ°´å°é¢„ç•™æ¥å£

## ğŸ’¡ å…³é”®æç¤º

1. **å…ˆè·‘é€šæ¡†æ¶**ï¼šä¸è¦ä¸€å¼€å§‹å°±è¿½æ±‚å®Œç¾ï¼Œå…ˆè®©åŸºç¡€ç»“æ„èƒ½è¿è¡Œ
2. **é€æ­¥æ›¿æ¢**ï¼šç”¨å ä½ç¬¦ä»£ç å…ˆæ­å»ºæ¡†æ¶ï¼Œå†é€æ­¥æ›¿æ¢ä¸ºçœŸå®å®ç°
3. **å…³æ³¨æ¥å£**ï¼šä¿æŒç®€å•ä¸€è‡´çš„APIè®¾è®¡
4. **æµ‹è¯•é©±åŠ¨**ï¼šæ¯å®Œæˆä¸€ä¸ªåŠŸèƒ½å°±æµ‹è¯•ä¸€ä¸‹

è¿™ä¸ªç®€åŒ–ç‰ˆæœ¬æ›´é€‚åˆå­¦ä¹ å’Œå¿«é€ŸåŸå‹å¼€å‘ï¼Œå®Œæˆåå†è€ƒè™‘æ·»åŠ é«˜çº§åŠŸèƒ½ï¼ğŸš€ 