# 简化版多模态水印工具 - 快速上手指南

## 🎯 目标明确

我们要做的是一个**最小可用**的多模态水印工具：
- ✅ **文本水印**：只用CredID算法  
- ✅ **图像水印**：只用Stable Signature算法
- ✅ **统一接口**：一个Engine类搞定所有操作
- ❌ 不要复杂的评估模块
- ❌ 不要多算法支持
- ❌ 不要复杂的抽象层

## 🚀 第一步：创建项目

### 1. 基础目录结构

```bash
mkdir mmwt && cd mmwt

# 创建核心目录
mkdir -p src/{text_watermark,image_watermark,utils}
mkdir -p config examples tests models

# 创建必要文件
touch README.md requirements.txt setup.py
touch src/__init__.py
touch src/text_watermark/__init__.py
touch src/image_watermark/__init__.py
touch src/utils/__init__.py
```

### 2. 安装依赖

```bash
# requirements.txt
cat > requirements.txt << EOF
torch>=1.12.0
transformers>=4.19.2
numpy>=1.20.0
torchvision
Pillow
omegaconf>=2.1.1
pyyaml
tqdm
click
EOF

pip install -r requirements.txt
```

## 📝 第二步：核心引擎实现

### 创建统一引擎 (`src/watermark_engine.py`)

```python
import yaml
import os

class WatermarkEngine:
    """简单的多模态水印引擎"""
    
    def __init__(self, base_dir="."):
        self.base_dir = base_dir
        self.text_watermark = None
        self.image_watermark = None
    
    def _load_text_watermark(self):
        """懒加载文本水印"""
        if self.text_watermark is None:
            from .text_watermark.credid_watermark import CredIDWatermark
            config_path = os.path.join(self.base_dir, "config/text_config.yaml")
            self.text_watermark = CredIDWatermark(config_path)
        return self.text_watermark
    
    def _load_image_watermark(self):
        """懒加载图像水印"""
        if self.image_watermark is None:
            from .image_watermark.stable_signature import StableSignatureWatermark
            config_path = os.path.join(self.base_dir, "config/image_config.yaml")
            self.image_watermark = StableSignatureWatermark(config_path)
        return self.image_watermark
    
    # 文本水印接口
    def embed_text(self, model, tokenizer, prompt, message):
        return self._load_text_watermark().embed(model, tokenizer, prompt, message)
    
    def extract_text(self, watermarked_text):
        return self._load_text_watermark().extract(watermarked_text)
    
    # 图像水印接口  
    def embed_image(self, model, prompt, message):
        return self._load_image_watermark().embed(model, prompt, message)
    
    def extract_image(self, watermarked_image):
        return self._load_image_watermark().extract(watermarked_image)
```

## 🔧 第三步：复制原始代码

### 1. 从CredID项目复制代码

```bash
# 在mmwt目录下
cp -r /path/to/credible_LLM_watermarking/watermarking/CredID src/text_watermark/credid

# 复制必要的工具函数
cp /path/to/credible_LLM_watermarking/src/utils/*.py src/utils/
```

### 2. 从Stable Signature项目复制代码

```bash
# 复制核心实现文件
cp -r /path/to/stable_signature/src src/image_watermark/stable_sig
cp /path/to/stable_signature/utils*.py src/image_watermark/
```

## 📄 第四步：创建配置文件

### 文本配置 (`config/text_config.yaml`)

```yaml
method: "CredID"
model_name: "huggyllama/llama-7b"  # 可根据需要修改
max_new_tokens: 110
num_beams: 4

# CredID算法参数（来自原始CredID.json）
lm_params:
  delta: 1.5
  prefix_len: 10
  message_len: 10
  permutation_num: 50

wm_params:
  encode_ratio: 10
  max_confidence: 0.5
  strategy: "max_confidence_updated"
```

### 图像配置 (`config/image_config.yaml`)

```yaml
method: "stable_signature"
message_length: 48
decoder_path: "models/dec_48b_whit.torchscript.pt"

# 扩散模型设置
diffusion:
  model_name: "stabilityai/stable-diffusion-2"
  num_inference_steps: 50
  guidance_scale: 7.5
```

## 🎨 第五步：创建封装类

### 文本水印封装 (`src/text_watermark/credid_watermark.py`)

```python
import yaml
import sys
import os

# 添加CredID模块到路径
credid_path = os.path.join(os.path.dirname(__file__), 'credid')
sys.path.append(credid_path)

class CredIDWatermark:
    """CredID算法的简单封装"""
    
    def __init__(self, config_path):
        with open(config_path, 'r') as f:
            self.config = yaml.safe_load(f)
        
        # 这里需要根据实际的CredID实现来调整
        # 先创建一个占位符实现
        self._setup_credid()
    
    def _setup_credid(self):
        """初始化CredID组件"""
        # TODO: 根据实际的CredID实现来初始化
        # 可能需要导入 message_model_processor 等
        pass
    
    def embed(self, model, tokenizer, prompt, message):
        """嵌入文本水印"""
        # TODO: 调用实际的CredID嵌入逻辑
        # 这里先返回示例结果
        watermarked_text = f"{prompt} [WATERMARKED with {message}]"
        
        return {
            'watermarked_text': watermarked_text,
            'message': message,
            'success': True
        }
    
    def extract(self, watermarked_text):
        """提取文本水印"""
        # TODO: 调用实际的CredID提取逻辑
        # 这里先返回示例结果
        if '[WATERMARKED with' in watermarked_text:
            # 简单的示例提取
            return {
                'extracted_message': "demo_message",
                'confidence': 0.95,
                'success': True
            }
        
        return {
            'extracted_message': None,
            'confidence': 0.0,
            'success': False
        }
```

### 图像水印封装 (`src/image_watermark/stable_signature.py`)

```python
import yaml
import sys
import os
from PIL import Image

class StableSignatureWatermark:
    """Stable Signature算法的简单封装"""
    
    def __init__(self, config_path):
        with open(config_path, 'r') as f:
            self.config = yaml.safe_load(f)
        
        self._setup_stable_signature()
    
    def _setup_stable_signature(self):
        """初始化Stable Signature组件"""
        # TODO: 根据实际的Stable Signature实现来初始化
        pass
    
    def embed(self, model, prompt, message):
        """嵌入图像水印"""
        # TODO: 调用实际的Stable Signature嵌入逻辑
        # 这里先返回示例结果
        dummy_image = Image.new('RGB', (512, 512), color='red')
        
        return {
            'watermarked_image': dummy_image,
            'message': message,
            'success': True
        }
    
    def extract(self, watermarked_image):
        """提取图像水印"""
        # TODO: 调用实际的Stable Signature提取逻辑
        # 这里先返回示例结果
        return {
            'extracted_message': "demo_image_message",
            'confidence': 0.88,
            'success': True
        }
```

## 🧪 第六步：测试运行

### 创建简单测试 (`examples/quick_test.py`)

```python
import sys
import os
sys.path.append(os.path.join(os.path.dirname(__file__), '..', 'src'))

from watermark_engine import WatermarkEngine

def test_basic_functionality():
    """测试基础功能"""
    print("🧪 开始测试多模态水印工具...")
    
    # 初始化引擎
    engine = WatermarkEngine(base_dir="..")
    
    # 测试文本水印（先用简单示例）
    print("\n📝 测试文本水印...")
    try:
        text_result = engine.embed_text(None, None, "Hello world", "secret123")
        print(f"✅ 嵌入成功: {text_result}")
        
        extracted = engine.extract_text(text_result['watermarked_text'])
        print(f"✅ 提取成功: {extracted}")
    except Exception as e:
        print(f"❌ 文本水印测试失败: {e}")
    
    # 测试图像水印
    print("\n🖼️ 测试图像水印...")
    try:
        image_result = engine.embed_image(None, "a cat", "secret456")
        print(f"✅ 嵌入成功: 图像大小 {image_result['watermarked_image'].size}")
        
        extracted = engine.extract_image(image_result['watermarked_image'])
        print(f"✅ 提取成功: {extracted}")
    except Exception as e:
        print(f"❌ 图像水印测试失败: {e}")
    
    print("\n🎉 基础测试完成！")

if __name__ == "__main__":
    test_basic_functionality()
```

### 运行测试

```bash
cd examples
python quick_test.py
```

## 📚 第七步：完善实现

当基础框架可以运行后，逐步完善：

### 1. 研究CredID实现
```bash
# 查看CredID的关键文件
ls credible_LLM_watermarking/watermarking/CredID/
# 重点关注：
# - message_model_processor.py
# - base_processor.py
```

### 2. 研究Stable Signature实现
```bash
# 查看Stable Signature的关键文件
ls stable_signature/
# 重点关注：
# - finetune_ldm_decoder.py
# - decoding.ipynb
# - utils_model.py
```

### 3. 逐步替换占位符代码
- 在`credid_watermark.py`中实现真实的CredID调用
- 在`stable_signature.py`中实现真实的Stable Signature调用

## 🎯 成功标准

当你完成这个简化版本时，应该能够：

1. ✅ **基础功能**：通过统一接口进行文本和图像水印的嵌入/提取
2. ✅ **配置驱动**：通过YAML文件配置算法参数
3. ✅ **代码清晰**：结构简单，易于理解和修改
4. ✅ **可扩展**：为未来添加音频/视频水印预留接口

## 💡 关键提示

1. **先跑通框架**：不要一开始就追求完美，先让基础结构能运行
2. **逐步替换**：用占位符代码先搭建框架，再逐步替换为真实实现
3. **关注接口**：保持简单一致的API设计
4. **测试驱动**：每完成一个功能就测试一下

这个简化版本更适合学习和快速原型开发，完成后再考虑添加高级功能！🚀 